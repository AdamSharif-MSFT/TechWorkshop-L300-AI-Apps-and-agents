name: Inventory Agent Workflow

on:
  push:
    paths:
      - 'src/app/agents/inventoryAgent_initializer.py'
      - 'src/prompts/InventoryAgentPrompt.txt'
      - 'src/app/tools/inventoryCheck.py'
      - 'src/app/servers/mcp_inventory_server.py'
      - 'src/app/agents/agent_processor.py'
    branches: [ main, develop ]
  pull_request:
    paths:
      - 'src/app/agents/inventoryAgent_initializer.py'
      - 'src/prompts/InventoryAgentPrompt.txt'
      - 'src/app/tools/inventoryCheck.py'
      - 'src/app/servers/mcp_inventory_server.py'
      - 'src/app/agents/agent_processor.py'
    branches: [ main ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.12'

jobs:
  run-inventory-agent:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r src/requirements.txt
    
    - name: Create .env file from secrets
      run: |
        echo "${{ secrets.ENV }}" > src/.env
    
    - name: Azure CLI Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Set up Azure CLI and authenticate
      run: |
        # Ensure Azure CLI is available and authenticated
        az account show
        
        # Set additional environment variables for Azure AI Projects
        echo "AZURE_CLIENT_ID=${{ secrets.AZURE_CLIENT_ID }}" >> $GITHUB_ENV
        echo "AZURE_CLIENT_SECRET=${{ secrets.AZURE_CLIENT_SECRET }}" >> $GITHUB_ENV
        echo "AZURE_TENANT_ID=${{ secrets.AZURE_TENANT_ID }}" >> $GITHUB_ENV
    
    - name: Validate environment variables
      run: |
        cd src
        python -c "
        import os
        from dotenv import load_dotenv
        load_dotenv()
        
        required_vars = [
            'AZURE_AI_AGENT_ENDPOINT',
            'AZURE_AI_AGENT_MODEL_DEPLOYMENT_NAME'
        ]
        
        missing_vars = []
        for var in required_vars:
            if not os.getenv(var):
                missing_vars.append(var)
        
        if missing_vars:
            print(f'Missing required environment variables: {missing_vars}')
            exit(1)
        else:
            print('All required environment variables are present')
        "
    
    - name: Validate Inventory Agent Prompt
      run: |
        cd src
        python -c "
        import os
        prompt_path = os.path.join('prompts', 'InventoryAgentPrompt.txt')
        if os.path.exists(prompt_path):
            with open(prompt_path, 'r', encoding='utf-8') as f:
                content = f.read()
                print(f'Inventory Agent prompt loaded successfully ({len(content)} characters)')
        else:
            print('Error: InventoryAgentPrompt.txt not found')
            exit(1)
        "
    
    - name: Test inventory check tool
      run: |
        cd src
        python -c "
        import sys
        sys.path.append('.')
        try:
            from app.tools.inventoryCheck import *
            print('Inventory check tool imported successfully')
        except Exception as e:
            print(f'Error importing inventory check tool: {e}')
            # Don't exit(1) as this might be optional
        "
      env:
        PYTHONPATH: ${{ github.workspace }}/src
    
    - name: Test MCP inventory server
      run: |
        cd src
        python -c "
        import sys
        sys.path.append('.')
        try:
            from app.servers.mcp_inventory_server import *
            print('MCP inventory server imported successfully')
        except Exception as e:
            print(f'Error importing MCP inventory server: {e}')
            # Don't exit(1) as this might be optional
        "
      env:
        PYTHONPATH: ${{ github.workspace }}/src
    
    - name: Run Inventory Agent Initializer
      run: |
        cd src
        python -m app.agents.inventoryAgent_initializer
      env:
        PYTHONPATH: ${{ github.workspace }}/src
    
    - name: Validate agent initialization
      run: |
        cd src
        python -c "
        import os
        from dotenv import load_dotenv
        load_dotenv()
        
        # Basic validation that the script ran successfully
        agent_env_var = os.getenv('inventory_agent')
        if agent_env_var:
            print(f'Inventory agent initialized successfully: {agent_env_var[:50]}...')
        else:
            print('Warning: Inventory agent environment variable not found')
        "
    
    - name: Test agent processor inventory function
      run: |
        cd src
        python -c "
        import sys
        sys.path.append('.')
        from app.agents.agent_processor import create_function_tool_for_agent
        
        try:
            functions = create_function_tool_for_agent('inventory_agent')
            print('Inventory agent function tools created successfully')
            print(f'Function tool type: {type(functions)}')
        except Exception as e:
            print(f'Error creating inventory agent function tools: {e}')
            exit(1)
        "
      env:
        PYTHONPATH: ${{ github.workspace }}/src
    
    - name: Clean up secrets
      if: always()
      run: |
        rm -f src/.env
    
    - name: Upload logs as artifacts
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: inventory-logs-${{ github.run_id }}
        path: |
          src/*.log
          src/logs/
        retention-days: 7